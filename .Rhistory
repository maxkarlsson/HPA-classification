for (i in seq_len(n)) {
cat(i, "/", n, "- ETA:", getTimeAsString(ETA))
flush.console()
Sys.sleep(sluggishness)
dt <- proc.time()[3] - t0
cat(" - elapsed:", getTimeAsString(dt), "\n")
ETA <- (n - i) * dt / i
}
n <- 10
t0 <- proc.time()[3]
ETA <- NULL
for (i in seq_len(n)) {
cat(i, "/", n, "- ETA:", getTimeAsString(ETA))
flush.console()
Sys.sleep(0.2)
dt <- proc.time()[3] - t0
cat(" - elapsed:", getTimeAsString(dt), "\n")
ETA <- (n - i) * dt / i
}
for (i in seq_len(n)) {
cat(i, "/", n, "- ETA:", getTimeAsString(ETA))
flush.console()
Sys.sleep(0.2)
dt <- proc.time()[3] - t0
cat(" - elapsed:", getTimeAsString(dt))
ETA <- (n - i) * dt / i
}
flush.console()
pb <- timerProgressBar(min = 0, max = 10)
on.exit(close(pb))
for (i in seq(0, 1, 0.05)) {
Sys.sleep(0.2)
setTimerProgressBar(pb, i)
}
number_of_settings <- nrow(expand.grid(enrich_fold_settings, under_lim_settings, group_num_settings))
invisible(NULL)
?invisible
library(pbapply)
enrich_fold_settings <- seq(3,7,0.5)
under_lim_settings <- seq(1,8,0.25)
group_num_settings <- c(6)#seq(5,11,1)
number_of_settings <- nrow(expand.grid(enrich_fold_settings, under_lim_settings, group_num_settings))
cat(paste(number_of_settings, "settings\nIt takes ~1 min per setting.\n"))
first <- T
pb <- timerProgressBar(min = 1, max = number_of_settings)
on.exit(close(pb))
i = 1
for(enrich_fold in enrich_fold_settings) {
for(under_lim in under_lim_settings) {
for(group_num in group_num_settings) {
setTimerProgressBar(pb, i)
i <- i + 1
atlas_categories_temp <-
get.categories.with.num.expressed(all.atlas.max,
max_column = "limma_gene_dstmm.zero.impute.expression_maxEx",
cat_column = "consensus_content_name",
enrich.fold = enrich_fold,
under.lim = under_lim,
group.num = group_num) %>%
mutate(enrich_fold = enrich_fold,
under_lim = under_lim,
group_num = group_num)
if(first){
first <- F
atlas_categories <- atlas_categories_temp
} else {
atlas_categories <- rbind(atlas_categories, atlas_categories_temp)
}
}
}
}
readr::write_delim(atlas_categories, paste(result_folder, "atlas_categories_test.txt", sep = "/"), delim = "\t")
atlas_categories %>%
group_by(enrich_fold, under_lim, group_num)
atlas_categories %>%
group_by(enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2))
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2))
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, enrich_fold, label = number, size = number, color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, enrich_fold, label = number, color = elevated.category)) +
geom_point(aes(size = number))+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
install.packages("rgl")
library(rgl)
clear3d()
make_3d_gif_rgl <- function(x, y, z, Group, Color = "black", GroupColor = NA, GroupTextColor = "black", GroupTextcex = 2, GroupTextJust = c(0,0,0),
bgcol = NA,
sphere.r = 0.2, sphere = F,
legend.pos = "bottom", legend = F,
legend.cex = 4, legend.ncol = 1, legend.bty = "n",
legend.text.col = "black",
axes.col = "black",
save = F, savefile = "",
ellipse = T,
ellipse.subdivisions = 5,
groupLabels = F,
duration = 10, spin.axis = c(0, -1, 1),
size = 1000, zoom = 1,
plot.axes = T,
ellipse.alpha = 0.2, point.alpha = 1) {
require(rgl)
# Assert that input are correct formats
stopifnot(!anyNA(x), is.numeric(x))
stopifnot(!anyNA(y), is.numeric(y))
stopifnot(!anyNA(z), is.numeric(z))
# If GroupColor is NA, use Color
if(is.na(GroupColor[[1]]) & length(GroupColor)) GroupColor <- Color
if(save) {
stopifnot(nchar(savefile) != 0, is.character(savefile))
temp_savedir <- paste(savefile, "TEMP", sep = "_")
dir.create(temp_savedir, showWarnings = FALSE)
}
# Calculate group means
data_means <-
tibble(x, y, z, Group) %>%
group_by(Group) %>%
dplyr::summarise(x.mean = mean(x) + GroupTextJust[1],
y.mean = mean(y) + GroupTextJust[2],
z.mean = mean(z) + GroupTextJust[3])
# Make clear plot space
rgl::clear3d()
par3d(windowRect = c(0, 0, size, size)) # make the window large
par3d(zoom = zoom)
if(sphere) {
rgl.spheres(x, y, z, r = sphere.r, color = Color)
} else {
plot3d(x, y, z,
col = Color,
size = 15,
axes = plot.axes, add = T,
alpha = point.alpha)
}
lim <- function(x){c(-max(abs(x)), max(abs(x))) * 1.1}
if(plot.axes) {
rgl.lines(lim(x), c(0, 0), c(0, 0), color = axes.col)
rgl.lines(c(0, 0), lim(y), c(0, 0), color = axes.col)
rgl.lines(c(0, 0), c(0, 0), lim(z), color = axes.col)
}
if(legend){
bgplot3d({
par(bg = bgcol)
plot.new()
legend(legend.pos, legend = unique(Group), pch = 16, col = unique(GroupColor),
cex=legend.cex, inset=c(0.02), ncol = legend.ncol, bty = legend.bty,
text.col = legend.text.col)})
} else {
rgl.bg(color = bgcol)
}
if(ellipse){
for (g in unique(Group)){
tibble(x, y, z) %>%
filter(Group==g) %>%
{shade3d(ellipse3d(x = cov(.), centre = colMeans(.), level = 0.95, smooth = T, subdivide = ellipse.subdivisions),
col = GroupColor[Group == g][1], alpha = 0.2)}
}
}
if(groupLabels) {
data_means %$%
text3d(x.mean, y.mean, z.mean, texts = Group, col = GroupTextColor, cex = GroupTextcex)
}
spinner <- spin3d(axis = spin.axis, rpm = 60/duration)
if(save) {
movie3d(spinner,
duration = duration,
dir = temp_savedir,
fps = 20)
} else {
play3d(spinner,
duration = duration)
}
if(save) {
file.rename(from = paste(temp_savedir, "movie.gif", sep = "/"),
to = savefile)
unlink(temp_savedir, recursive = T)
}
}
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2))
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(enrich_fold, under_lim, number, elevated.category, GroupColor = elevated.cat.cols[match(names(elevated.category), elevated.cat.cols)])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$% elevated.cat.cols[match(names(elevated.category), elevated.cat.cols)]
elevated.cat.cols
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$% elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))]
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(enrich_fold, under_lim, number, elevated.category,
GroupColor = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(enrich_fold, under_lim, number, elevated.category,
GroupColor = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2))
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold, y = under_lim, z = number,
elevated.category,
GroupColor = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold, y = under_lim, z = number,
group = elevated.category,
GroupColor = elevated.cat.cols)#elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold, y = under_lim, z = number,
Group = elevated.category,
GroupColor = elevated.cat.cols)#elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = elevated.category,
GroupColor = elevated.cat.cols)#elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = elevated.category,
GroupColor = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = elevated.category,
GroupColor = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))],
sphere = T)
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = elevated.category,
Color = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))],
sphere = T)
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = elevated.category,
Color = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))])
atlas_categories %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = elevated.category,
Color = elevated.cat.cols[match(elevated.category, names(elevated.cat.cols))], ellipse = F)
atlas_categories %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %$%
make_3d_gif_rgl(x = enrich_fold/max(enrich_fold), y = under_lim/max(under_lim), z = number/max(number),
Group = express.category.2,
Color = expressed.cat.cols[match(express.category.2, names(expressed.cat.cols))], ellipse = F)
for(enrich_fold in unique(atlas_categories$enrich_fold)) {print(enrich_fold)}
enrich_fold_setting = 3
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
for(enrich_fold_setting in unique(atlas_categories$enrich_fold)) {
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed fold ", enrich_fold, ".png"), sep = "/"), width = 8, height = 8)
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated fold ", enrich_fold, ".png"), sep = "/"), width = 8, height = 8)
}
for(under_lim_setting in unique(atlas_categories$under_lim)) {
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed under lim ", enrich_fold, ".png"), sep = "/"), width = 8, height = 8)
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated under lim ", enrich_fold, ".png"), sep = "/"), width = 8, height = 8)
}
for(enrich_fold_setting in unique(atlas_categories$enrich_fold)) {
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed fold ", enrich_fold_setting, ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated fold ", enrich_fold_setting, ".png"), sep = "/"), width = 16, height = 8)
}
for(enrich_fold_setting in unique(atlas_categories$enrich_fold)) {
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed fold ", enrich_fold_setting, ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated fold ", enrich_fold_setting, ".png"), sep = "/"), width = 16, height = 8)
}
for(under_lim_setting in unique(atlas_categories$under_lim)) {
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed under lim ", under_lim_setting, ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated under lim ", under_lim_setting, ".png"), sep = "/"), width = 16, height = 8)
}
for(enrich_fold_setting in unique(atlas_categories$enrich_fold)) {
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed fold ", round(enrich_fold_setting, 1), ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated fold ", round(enrich_fold_setting, 1), ".png"), sep = "/"), width = 16, height = 8)
}
for(under_lim_setting in unique(atlas_categories$under_lim)) {
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(enrich_fold, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed under lim ", round(under_lim_setting, 1), ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(enrich_fold, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated under lim ", round(under_lim_setting, 1), ".png"), sep = "/"), width = 16, height = 8)
}
round(3, 1)
round(3, 2)
format(3, nsmall = 2)
for(enrich_fold_setting in unique(atlas_categories$enrich_fold)) {
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(under_lim, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed fold ", format(enrich_fold_setting, nsmall = 2), ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(enrich_fold == enrich_fold_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(under_lim, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated fold ", format(enrich_fold_setting, nsmall = 2), ".png"), sep = "/"), width = 16, height = 8)
}
for(under_lim_setting in unique(atlas_categories$under_lim)) {
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(express.category.2, enrich_fold, under_lim, group_num) %>%
summarise(number = length(express.category.2)) %>%
ggplot(aes(enrich_fold, number, label = number,color = express.category.2)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = expressed.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings expressed under lim ", format(under_lim_setting, nsmall = 2), ".png"), sep = "/"), width = 16, height = 8)
atlas_categories %>%
filter(under_lim == under_lim_setting) %>%
group_by(elevated.category, enrich_fold, under_lim, group_num) %>%
summarise(number = length(elevated.category)) %>%
ggplot(aes(enrich_fold, number, label = number,color = elevated.category)) +
geom_point()+
geom_line()+
geom_text(vjust = -0.5)+
scale_color_manual(values = elevated.cat.cols) +
simple_theme
ggsave(paste(result_folder, paste0("settings elevated under lim ", format(under_lim_setting, nsmall = 2), ".png"), sep = "/"), width = 16, height = 8)
}
